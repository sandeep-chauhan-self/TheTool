name: Daily Cleanup - Analysis Jobs

on:
  schedule:
    # Run daily at 2 AM UTC (adjust cron expression for your timezone)
    # Format: minute hour day month day-of-week
    # 0 2 * * * = 2 AM UTC every day
    # For 2 AM IST (UTC+5:30), use: 30 20 * * * (8:30 PM UTC previous day)
    - cron: '0 2 * * *'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup old jobs and deduplicate results
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
      
      - name: Run cleanup script
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PYTHONPATH: backend
        run: |
          cd backend
          python scripts/cleanup_old_jobs.py
      
      - name: Upload cleanup logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-logs-${{ github.run_id }}
          path: logs/cleanup.log
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Cleanup failed. Check logs above."
          exit 1
